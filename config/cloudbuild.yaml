steps:
  - id: "fetch mvn settings.xml"
    name: "gcr.io/cloud-builders/gsutil"
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil ls gs://clamp-maven
        gsutil cp gs://clamp-maven/settings.xml .
        ls .
        sed -i -e 's/CLAMP_REG_PASSWORD/$${CLAMP_REG_PASSWORD}/g' settings.xml
        cat settings.xml
    secretEnv: ['CLAMP_REG_PASSWORD']
  - id: "build and deploy to dataflow"
    name: "gcr.io/cloud-builders/mvn:3.5.0-jdk-8"
    entrypoint: 'bash'
    env:
      - 'PRIVATE_CLAMP_REPO_URL=${_PRIVATE_CLAMP_REPO_URL}'
    args:
      - '-c'
      - |
        echo "Build identifier = ${BUILD_ID}_${SHORT_SHA}"
        mvn compile exec:java \
          --settings settings.xml
          -Dexec.mainClass="org.allofus.curation.pipeline.ExampleWordCount" \
          -Dexec.args="--project=${PROJECT_ID} \
            --gcpTempLocation=$${LOCATION}/tmp \
            --runner=DataflowRunner \
            --input=$${LOCATION}/input/* \
            --output=$${LOCATION}/output \
            --subnetwork=$${SUBNET} \
            --maxNumWorkers=5 \
            --buildId=${BUILD_ID}_${SHORT_SHA} \
            --region=us-central1" \
          -Pdataflow-runner -P dataflow
    secretEnv: ['LOCATION', 'SUBNET']
availableSecrets:
  secretManager:
    - versionName: projects/${PROJECT_ID}/secrets/dataflow-location/versions/latest
      env: 'LOCATION'
    - versionName: projects/${PROJECT_ID}/secrets/dataflow-subnet/versions/latest
      env: 'SUBNET'
    - versionName: projects/${PROJECT_ID}/secrets/artifact-reg-clamp-password/versions/latest
      env: 'CLAMP_REG_PASSWORD'
